package me.alpha432.oyvey.features.modules.combat;

import me.alpha432.oyvey.features.modules.Module;
import me.alpha432.oyvey.features.settings.Setting;
import me.alpha432.oyvey.event.impl.PacketEvent;
import me.alpha432.oyvey.event.system.Subscribe;
import net.minecraft.network.protocol.game.ClientboundAddEntityPacket;
import net.minecraft.world.entity.Entity;
import net.minecraft.world.entity.player.Player;
import java.util.HashSet;
import java.util.Set;
import java.util.UUID;

public class AntiBot extends Module {
    private final Set<UUID> botPlayers = new HashSet<>();
    private final Setting<Boolean> remove = new Setting<>("Remove", true);
    private final Setting<Boolean> noAttack = new Setting<>("NoAttack", true);
    
    public AntiBot() {
        super("AntiBot", "Detects and handles server bots", Category.COMBAT);
    }
    
    @Subscribe
    public void onPacketReceive(PacketEvent.Receive event) {
        if (!isEnabled() || mc.level == null) return;
        
        if (event.getPacket() instanceof ClientboundAddEntityPacket packet) {
            // Check for suspicious entity spawns
            Entity entity = mc.level.getEntity(packet.getId());
            if (entity instanceof Player player) {
                // Bot detection logic
                if (isBot(player)) {
                    botPlayers.add(player.getUUID());
                    
                    if (remove.getValue()) {
                        mc.level.removeEntity(packet.getId(), Entity.RemovalReason.DISCARDED);
                    }
                }
            }
        }
    }
    
    private boolean isBot(Player player) {
        // Simple bot detection heuristics
        if (player.getName().getString().isEmpty()) return true;
        if (player.getUUID().version() != 4) return true; // Check for valid UUID
        if (player.tickCount < 20 && player.isOnGround()) return true; // New entity instantly on ground
        return false;
    }
    
    public boolean isBotPlayer(Player player) {
        return botPlayers.contains(player.getUUID());
    }
    
    @Override
    public void onEnable() {
        botPlayers.clear();
    }
    
    @Override
    public void onDisable() {
        botPlayers.clear();
    }
    
    @Override
    public String getDisplayInfo() {
        return botPlayers.size() + "";
    }
}
