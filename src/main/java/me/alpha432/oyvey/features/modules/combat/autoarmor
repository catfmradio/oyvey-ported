package me.alpha432.oyvey.features.modules.combat;

import me.alpha432.oyvey.features.modules.Module;
import me.alpha432.oyvey.event.impl.UpdateEvent;
import me.alpha432.oyvey.event.system.Subscribe;
import net.minecraft.world.item.ArmorItem;
import net.minecraft.world.item.ItemStack;
import net.minecraft.world.item.Items;

public class AutoArmor extends Module {
    private int delay = 0;
    
    public AutoArmor() {
        super("AutoArmor", "Automatically equips better armor", Category.COMBAT);
    }
    
    @Subscribe
    public void onUpdate(UpdateEvent event) {
        if (!isEnabled() || mc.player == null || delay > 0) {
            if (delay > 0) delay--;
            return;
        }
        
        // Check each armor slot
        for (int slot = 36; slot < 40; slot++) { // 36-39 are armor slots
            int armorType = slot - 36; // 0: boots, 1: leggings, 2: chestplate, 3: helmet
            
            ItemStack currentArmor = mc.player.getInventory().getItem(slot);
            ItemStack bestArmor = findBestArmor(armorType);
            
            if (!bestArmor.isEmpty() && 
                (currentArmor.isEmpty() || 
                 getArmorValue(bestArmor) > getArmorValue(currentArmor))) {
                
                // Swap armor
                mc.player.getInventory().setItem(slot, bestArmor);
                delay = 5; // Small delay to prevent spam
                break;
            }
        }
    }
    
    private ItemStack findBestArmor(int armorType) {
        ItemStack best = ItemStack.EMPTY;
        int bestValue = -1;
        
        for (int i = 0; i < 36; i++) { // Check main inventory
            ItemStack stack = mc.player.getInventory().getItem(i);
            if (stack.getItem() instanceof ArmorItem armorItem) {
                // Check if correct armor type
                if (armorItem.getSlot().getIndex() == armorType) {
                    int value = getArmorValue(stack);
                    if (value > bestValue) {
                        bestValue = value;
                        best = stack;
                    }
                }
            }
        }
        
        return best;
    }
    
    private int getArmorValue(ItemStack stack) {
        if (!(stack.getItem() instanceof ArmorItem armor)) return 0;
        
        // Consider armor points and durability
        float durabilityPercent = (float) stack.getDamageValue() / stack.getMaxDamage();
        return (int) (armor.getDefense() * (1.0f - durabilityPercent));
    }
    
    @Override
    public void onEnable() {
        delay = 0;
    }
    
    @Override
    public void onDisable() {
        // Nothing needed
    }
}
