package me.alpha432.oyvey.features.modules.combat;

import me.alpha432.oyvey.features.modules.Module;
import me.alpha432.oyvey.features.settings.Setting;
import me.alpha432.oyvey.event.impl.UpdateEvent;
import me.alpha432.oyvey.event.system.Subscribe;
import net.minecraft.world.entity.Entity;
import net.minecraft.world.entity.player.Player;
import net.minecraft.world.phys.EntityHitResult;
import net.minecraft.world.phys.HitResult;

public class TriggerBot extends Module {
    private final Setting<Integer> delay = new Setting<>("Delay", 5, 0, 20);
    private final Setting<Boolean> playersOnly = new Setting<>("PlayersOnly", true);
    private final Setting<Float> range = new Setting<>("Range", 3.0f, 1.0f, 6.0f);
    
    private int ticks = 0;
    
    public TriggerBot() {
        super("TriggerBot", "Automatically attacks when crosshair is on target", Category.COMBAT);
    }
    
    @Subscribe
    public void onUpdate(UpdateEvent event) {
        if (!isEnabled() || mc.player == null || mc.level == null) return;
        
        ticks++;
        if (ticks < delay.getValue()) return;
        
        HitResult hitResult = mc.hitResult;
        if (hitResult == null || hitResult.getType() != HitResult.Type.ENTITY) return;
        
        EntityHitResult entityHit = (EntityHitResult) hitResult;
        Entity target = entityHit.getEntity();
        
        if (isValidTarget(target)) {
            // Check if within range
            if (mc.player.distanceTo(target) <= range.getValue()) {
                mc.gameMode.attack(mc.player, target);
                mc.player.swing(mc.player.getUsedItemHand());
                ticks = 0;
            }
        }
    }
    
    private boolean isValidTarget(Entity entity) {
        if (entity == null) return false;
        if (entity == mc.player) return false;
        if (playersOnly.getValue() && !(entity instanceof Player)) return false;
        if (!entity.isAlive()) return false;
        return true;
    }
    
    @Override
    public void onEnable() {
        ticks = 0;
    }
    
    @Override
    public void onDisable() {
        // Nothing needed
    }
    
    @Override
    public String getDisplayInfo() {
        return delay.getValue() + "t";
    }
}
